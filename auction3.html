<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCoãƒ¡ãƒ€ã‚«ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
    
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f7f6;
    margin: 0;
    padding: 20px;
    color: #333;
}

.container {
    max-width: 600px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 30px;
}

h1, h2 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 4vw;
}

hr {
    border: none;
    border-top: 1px dashed #e0e0e0;
    margin: 1vw 0;
}

.product-section {
    text-align: center;
}

.product-media img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: 80vw;
}

.product-description {
    font-size: 0.95em;
    color: #555;
    text-align: left;
}

.auction-info0 {
    text-align: center;
    font-size: 8vw;
    font-weight: bold;
    color:black;
}

.auction-info {
    text-align: center;
    font-size: 6vw;
    font-weight: bold;
    color:black;
}

.auction-info2 {
    text-align: center;
    font-size: 4vw;
    font-weight: bold;
    color:#27ae60;
}    

.bid-section {
    padding: 15px 20px 20px 20px;
    margin-top: 10px;
    background-color:lightblue;
    border-radius: 8px;
    border: 1px solid #eee;
}

.bid-section h2 {
    margin-top: 0;
    margin-bottom: 1px;
    font-size: 1.2em;
}

.bid-section_current {
    padding: 15px 20px 20px 20px;
    margin-top: 10px;
    background-color:;
    border-radius: 0.2vw;
    border: 1px solid black;
    box-shadow: 3px 2px 2px gray;
}

.bid-section_current h2 {
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #555;
}

.input-group input[type="number"] {
    width: calc(100% - 20px);
    padding: 12px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box;
}

.input-group input[type="checkbox"] {
    margin-right: 8px;
}

button {
    display: block;
    width: 100%;
    padding: 1vw;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

button:hover {
    background-color: #0056b3;
}

button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.message {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    color: #d35400;
}

.status-message {
    font-size: 1.2em;
    font-weight: normal;
    color: #27ae60;
    margin-top: 5px;
    font-weight: bold;
}

@media (max-width: 600px) {
    body {
        padding: 10px;
    }
    .container {
        padding: 20px;
        margin: 10px auto;
    }
    .product-media img {
        width: 100%;
    }
}

.input-group.horizontal {
    display: flex;
    align-items: center;
    gap: 10px;
}

.input-group.horizontal input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #007bff;
    margin: 0;
    display: inline-block;
}

.input-group.horizontal label {
    margin: 0;
    line-height: 1;
    display: inline-block;
}

.currency-input .input-wrapper {
    position: relative;
    width: 100%;
}

.currency-input input[type="number"] {
    width: 100%;
    padding: 12px 35px 12px 10px;
    text-align: right;
    font-size: 1em;
    box-sizing: border-box;
}

.currency-input .yen-label {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #555;
    font-size: 1em;
}

.time-info {
    text-align: center;
    font-size: 1em;
    color: #555;
    margin-top: 10px;
}

.countdown {
    font-size: 1.2em;
    font-weight: bold;
    color: #e74c3c;
    margin-top: 5px;
    text-align: center;
}

#bid-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

#modal-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
}

#modal-content {
    position: relative;
    background: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    width: 90vw;
    max-width: 400px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #007bff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.title-box {
  background-color: #f9f9f9;
  border: 2px solid #ccc;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 1.5em;
  text-align: center;
  margin: 20px 0;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
}

.bid-history-container {
  margin-top: 20px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #fff;
}

.bid-history-item {
  border-bottom: 1px solid #eee;
  padding: 10px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bid-history-item:last-child {
  border-bottom: none;
}

.bid-info {
  font-size: 1em;
  color: #333;
}

.bid-time {
  font-size: 0.8em;
  color: #999;
}

</style>
</head>
<body>

<div id="loading-screen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
">
  <div class="loader"></div>
</div>

<div class="container">
    <div class="product-section">
        <h2 id="auction-title" class="title-box">å“ç¨®å</h2>
        <div class="product-media">
            <img id="medaka-image" src="" alt="ãƒ¡ãƒ€ã‚«ã®ç”»åƒ">
        </div>
        <p id="item-overview" class="product-description">
            ----
        </p>
    </div>

    <div class="bid-section_current">
        <div class="auction-info">
            <p id="current-price-display">ç¾åœ¨ã®ä¾¡æ ¼: <span id="current-bid">--å††</span></p>
        </div>
        <div class="auction-info2">
            <p id="your-status" class="status-message"></p>
        </div>
    </div>
    
    <p class="countdown"><span id="time-remaining">--æ—¥--æ™‚é–“--åˆ†--ç§’</span></p>

    <div id="passcode-display" style="display: none; margin-top: 20px;">
        <p class="auction-info0" id="passcode-value"></p>
    </div>

    <p class="payment-info" id="payment-method-info" style="font-size: 0.8em; color: #666; margin-top: 5px;">
        â€»ä»£é‡‘ã¯ä»£é‡‘ç®±ã«å…¥ã‚Œã‚‹ã‹ã€PayPayã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚
    </p>
</div>

<div id="bid-modal" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;">
    <div style="
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 80vw;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h2 style="margin-top: 0;">å…¥æœ­å†…å®¹ã‚’å…¥åŠ›</h2>
        <div class="input-group currency-input">
            <label for="modal-bid-amount">å…¥æœ­é‡‘é¡ (100å††å˜ä½):</label>
            <div class="input-wrapper" style="position: relative;">
                <input type="number" id="modal-bid-amount" min="100" step="100" placeholder="ä¾‹: 1500" required>
                <span class="yen-label" style="
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #555;">å††</span>
            </div>
        </div>
        <div class="input-group horizontal" style="margin-top: 15px;">
            <input type="checkbox" id="modal-agree-checkbox" required>
            <label for="modal-agree-checkbox">ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³è¦ç´„ã«åŒæ„ã™ã‚‹</label>
        </div>
        <p id="modal-message" class="message" style="margin-top: 10px;"></p>
        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <button id="modal-cancel-button" style="width: 45%; background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="modal-submit-button" style="width: 45%;">å…¥æœ­ã™ã‚‹</button>
        </div>
    </div>
</div>

<div style="text-align:center; margin-top:20px;">
    <button id="bid-button">å…¥æœ­ã™ã‚‹</button>
    <button id="show-history-button" style="background-color: #2c3e50;">å…¥æœ­å±¥æ­´ã‚’è¡¨ç¤º</button>
    <p id="message" class="message"></p>
</div>

<div id="bid-history-container" class="bid-history-container" style="display:none;">
    <h3 style="margin-top: 0;">å…¥æœ­å±¥æ­´</h3>
    <div id="bid-history"></div>
</div>

<script>
function formatPrice(price) {
    if (typeof price !== 'number' && typeof price !== 'string' || isNaN(Number(price))) {
        console.warn('formatPrice: ç„¡åŠ¹ãªæ•°å€¤ãŒæ¸¡ã•ã‚Œã¾ã—ãŸ', price);
        return price; 
    }
    const numericPrice = Number(price);
    return new Intl.NumberFormat('ja-JP').format(numericPrice);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰åŒ¿åãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function hashUserId(userId) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æœ€åˆã®8æ–‡å­—ã‚’ä½¿ç”¨
    return 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼:' + userId.substring(0, 8);
}

const auctionId = getQueryParam("id");
const firebaseConfig = {
    apiKey: "AIzaSyBImwBMbP_4rbm-dsB2R8dhtlblA9HTBS8",
    authDomain: "coco-auction.firebaseapp.com",
    projectId: "coco-auction",
    storageBucket: "coco-auction.appspot.com",
    messagingSenderId: "12632824391",
    appId: "1:12632824391:web:ab6e784ba311de069eef62"
};
firebase.initializeApp(firebaseConfig);
    
let auctionEndTime;
let currentUserId = '';
let currentUserName = '';
let lastBidTime = 0;
const BID_COOLDOWN_SECONDS = 30;
    
const db = firebase.firestore();
const LIFF_ID = "1657196041-ALeOLrEa";
const VERIFY_URL = "https://us-central1-coco-auction.cloudfunctions.net/verifyLineTokenAndSignIn2";

function showLoading() {
    document.getElementById('loading-screen').style.display = 'flex';
}
function hideLoading() {
    document.getElementById('loading-screen').style.display = 'none';
}

function showModalMessage(text, type = 'info') {
    const msgEl = document.getElementById('modal-message');
    msgEl.textContent = text;
    msgEl.style.color = {
        success: '#27ae60',
        error: '#e74c3c',
        info: '#2980b9'
    }[type] || '#333';
}

function showStatusMessage(text, type = 'info') {
    const msgEl = document.getElementById('message');
    msgEl.textContent = text;
    msgEl.style.color = {
        success: '#27ae60',
        error: '#e74c3c',
        info: '#2980b9'
    }[type] || '#333';
}

function updateCurrentTime() {
    const now = new Date();
}

function updateCountdown() {
    if (!auctionEndTime) return;
    const now = new Date().getTime();
    const distance = auctionEndTime.getTime() - now;
    const bidButton = document.getElementById('bid-button');
    const yourStatusElement = document.getElementById('your-status');
    const passcodeDisplay = document.getElementById('passcode-display');
    const passcodeValue = document.getElementById('passcode-value');
    const currentPriceDisplayElement = document.getElementById('current-price-display');
    const paymentMethodInfo = document.getElementById('payment-method-info');
    
    if (distance < 0) {
        document.getElementById('time-remaining').textContent = 'ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã—ãŸ';
        bidButton.disabled = true;
        const currentAuctionData = window.currentAuctionData;
        if (currentAuctionData) {
            if (currentUserId && currentAuctionData.highestBidderId === currentUserId) {
                currentPriceDisplayElement.innerHTML = `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>${formatPrice(currentAuctionData.currentBid || currentAuctionData.startPrice || 100)}å††ã§è½æœ­ã—ã¾ã—ãŸğŸ‰`;
                yourStatusElement.textContent = '';
                db.collection('privateAuctionInfo').doc(auctionId).get().then(privateInfoDoc => {
                    if (privateInfoDoc.exists) {
                        const privateInfoData = privateInfoDoc.data();
                        passcodeValue.textContent = `æš—è¨¼ç•ªå·: ${privateInfoData.passcode || '---'}`;
                    } else {
                        passcodeValue.textContent = `æš—è¨¼ç•ªå·: --- (æƒ…å ±ãªã—)`;
                    }
                    passcodeDisplay.style.display = 'block';
                    paymentMethodInfo.style.display = 'block';
                }).catch(error => {
                    console.error("Failed to get private auction info:", error);
                    passcodeValue.textContent = `æš—è¨¼ç•ªå·: --- (å–å¾—ã‚¨ãƒ©ãƒ¼)`;
                    passcodeDisplay.style.display = 'block';
                    paymentMethodInfo.style.display = 'block';
                });
            } else {
                currentPriceDisplayElement.textContent = `æœ€çµ‚ä¾¡æ ¼ï¼š${formatPrice(currentAuctionData.currentBid || currentAuctionData.startPrice || 100)}å††`;
                yourStatusElement.textContent = `è½æœ­ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`;
                passcodeDisplay.style.display = 'none';
                paymentMethodInfo.style.display = 'none';
            }
        }
        return;
    }
    else {
        bidButton.disabled = false;
        passcodeDisplay.style.display = 'none';
        paymentMethodInfo.style.display = 'none';
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    document.getElementById('time-remaining').textContent =
        `çµ‚äº†ã¾ã§ï¼š${days}æ—¥${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
}

function updateAuctionUI(auctionData, latestBidAmount = 100, highestBidderId = null, yourBidAmount = 0) {
    document.getElementById('auction-title').textContent = auctionData.title || 'å“ç¨®å';
    document.getElementById("medaka-image").src = auctionData.imageUrl || auctionData.image || '';
    document.getElementById('item-overview').textContent = auctionData.description || '----';
    document.getElementById('current-bid').textContent = `${formatPrice(latestBidAmount)}å††`;

    if (currentUserId && highestBidderId === currentUserId) {
        document.getElementById('your-status').textContent = `ç¾åœ¨ã€æœ€é«˜å…¥æœ­è€…ã§ã™ã€‚`;
    } else {
        document.getElementById('your-status').textContent = `è½æœ­ã«ã¯å…¥æœ­ãŒå¿…è¦ã§ã™ã€‚`;
    }

    window.currentAuctionData = auctionData;
    updateCountdown();
}

function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

async function initializeLiffAndLoadAuction() {
    showLoading();
    document.getElementById('bid-button').disabled = true;

    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const idToken = await liff.getIDToken();
        try {
            const res = await fetch(VERIFY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
            });

            if (!res.ok) {
                console.error(`LINEèªè¨¼ã‚¨ãƒ©ãƒ¼: ${await res.text()}`);
                throw new Error('LINEèªè¨¼æƒ…å ±ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');
            }
            const json = await res.json();
            await firebase.auth().signInWithCustomToken(json.firebaseToken);
            currentUserId = firebase.auth().currentUser.uid;
            
            //Firestoreã‹ã‚‰ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è³¼èª­
            db.collection('auctions').doc(auctionId).onSnapshot(async (doc) => {
                if (doc.exists) {
                    const auctionData = doc.data();
                    auctionEndTime = auctionData.endTime ? auctionData.endTime.toDate() : null;
                    let yourBid = 0;
                    if (currentUserId) {
                        const userBidsSnapshot = await db.collection('auctions').doc(auctionId)
                                                        .collection('bids')
                                                        .where('userId', '==', currentUserId)
                                                        .orderBy('timestamp', 'desc')
                                                        .limit(1)
                                                        .get();
                        if (!userBidsSnapshot.empty) {
                            yourBid = userBidsSnapshot.docs[0].data().amount;
                            lastBidTime = userBidsSnapshot.docs[0].data().timestamp.toDate().getTime();
                        }
                    }
                    const initialDisplayBid = auctionData.currentBid || auctionData.startPrice || 100;
                    updateAuctionUI(auctionData, initialDisplayBid, auctionData.highestBidderId, yourBid);
                    
                    if (auctionEndTime && new Date().getTime() < auctionEndTime.getTime()) {
                        document.getElementById('bid-button').disabled = false;
                    } else {
                        document.getElementById('bid-button').disabled = true;
                    }
                    showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                } else {
                    showStatusMessage('æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    document.getElementById('bid-button').disabled = true;
                }
                hideLoading();
            }, (error) => {
                console.error("Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
                showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                hideLoading();
            });
            updateCurrentTime();
            setInterval(updateCountdown, 1000);
        } catch (authError) {
            console.error('Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', authError);
            alert('èªè¨¼æƒ…å ±ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            liff.login();
        }
    } catch (liffInitError) {
        console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', liffInitError);
        document.getElementById('message').textContent = 'åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        hideLoading();
    }
}

// â˜… æ–°ã—ã„é–¢æ•°: å…¥æœ­å±¥æ­´ã‚’è¡¨ç¤º
async function showBidHistory() {
    const historyContainer = document.getElementById('bid-history-container');
    const historyList = document.getElementById('bid-history');
    
    // å±¥æ­´ã‚’æ—¢ã«è¡¨ç¤ºã—ã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
    if (historyContainer.style.display === 'block') {
        historyContainer.style.display = 'none';
        return;
    }

    historyList.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
    historyContainer.style.display = 'block';

    try {
        const bidsRef = db.collection('auctions').doc(auctionId).collection('bids');
        const snapshot = await bidsRef.orderBy('timestamp', 'desc').get();
        
        if (snapshot.empty) {
            historyList.innerHTML = '<p style="text-align: center; color: #555;">å…¥æœ­å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        historyList.innerHTML = '';
        snapshot.forEach(doc => {
            const bid = doc.data();
            const bidTime = bid.timestamp.toDate();
            const formattedTime = `${bidTime.getMonth() + 1}/${bidTime.getDate()} ${bidTime.getHours()}:${String(bidTime.getMinutes()).padStart(2, '0')}:${String(bidTime.getSeconds()).padStart(2, '0')}`;
            const userName = hashUserId(bid.userId); // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼å
            const bidItem = document.createElement('div');
            bidItem.className = 'bid-history-item';
            bidItem.innerHTML = `
                <div class="bid-info">${userName}: Â¥${formatPrice(bid.amount)}</div>
                <div class="bid-time">${formattedTime}</div>
            `;
            historyList.appendChild(bidItem);
        });

    } catch (error) {
        console.error("å…¥æœ­å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        historyList.innerHTML = '<p style="text-align: center; color: #e74c3c;">å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
    }
}

window.addEventListener('DOMContentLoaded', initializeLiffAndLoadAuction);
document.getElementById('bid-button').addEventListener('click', () => {
    if (auctionEndTime && new Date().getTime() >= auctionEndTime.getTime()) {
        showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯æ—¢ã«çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚', 'error');
        return;
    }
    document.getElementById('modal-bid-amount').value = '';
    document.getElementById('modal-agree-checkbox').checked = false;
    showModalMessage('');
    document.getElementById('bid-modal').style.display = 'flex';
});

document.getElementById('modal-cancel-button').addEventListener('click', () => {
    document.getElementById('bid-modal').style.display = 'none';
});

document.getElementById('show-history-button').addEventListener('click', showBidHistory);

const functions = firebase.functions();
document.getElementById('modal-submit-button').addEventListener('click', async () => {
    const bidAmountInput = document.getElementById('modal-bid-amount');
    const newBidAmount = Number(bidAmountInput.value);
    const agreed = document.getElementById('modal-agree-checkbox').checked;

    if (!agreed) {
        showModalMessage('è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }
    if (isNaN(newBidAmount) || newBidAmount < 100 || newBidAmount % 100 !== 0) {
        showModalMessage('100å††å˜ä½ã§æ­£ã—ã„å…¥æœ­é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }
    if (!currentUserId) {
        showModalMessage('LINEãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚LIFFã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }
    if (!auctionId) {
        showModalMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
    }
    const now = new Date().getTime();
    if (lastBidTime && (now - lastBidTime) < (BID_COOLDOWN_SECONDS * 1000)) {
        const remainingTime = Math.ceil((BID_COOLDOWN_SECONDS * 1000 - (now - lastBidTime)) / 1000);
        showModalMessage(`å‰å›ã®å…¥æœ­ã‹ã‚‰${BID_COOLDOWN_SECONDS}ç§’çµŒéã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚ã¨${remainingTime}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`, 'error');
        return;
    }

    document.getElementById('modal-submit-button').disabled = true;
    showModalMessage('å…¥æœ­ä¸­...', 'info');

    try {
        const bidAuctionFunction = functions.httpsCallable('bidAuction');
        const result = await bidAuctionFunction({ auctionId: auctionId, amount: newBidAmount });
        if (result.data && result.data.success) {
            showStatusMessage(`å…¥æœ­ãŒæˆåŠŸã—ã¾ã—ãŸï¼`, 'success');
            document.getElementById('bid-modal').style.display = 'none';
            lastBidTime = now;
        } else if (result.data && result.data.message) {
            showModalMessage(`å…¥æœ­å¤±æ•—: ${result.data.message}`, 'error');
            console.error('Cloud Functionã‹ã‚‰ã®å…¥æœ­å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', result.data.message);
        } else {
            throw new Error('Cloud Functionã‹ã‚‰ã®äºˆæœŸã›ã¬ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã€‚');
        }
    } catch (error) {
        console.error('å…¥æœ­ã‚¨ãƒ©ãƒ¼:', error);
        alert('å…¥æœ­ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error);
        if (error.code) {
            showModalMessage(`å…¥æœ­ã‚¨ãƒ©ãƒ¼: ${error.message} (${error.code})`, 'error');
        } else {
            showModalMessage(`å…¥æœ­ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
        }
    } finally {
        document.getElementById('modal-submit-button').disabled = false;
    }
});
</script>
</body>
</html>




    
