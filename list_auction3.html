<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CoCoç„¡äººã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
      body {
  font-family: 'Helvetica Neue', sans-serif;
  margin: 20px;
  background-color: #f8f8f8; /* æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
  color: #222; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼æ–‡å­— */
}

.hidden {
  display: none;
}

.auction-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.auction-card {
  display: flex;
  align-items: center;
  border: 1px solid #ccc;
  border-radius: 0; /* ç›´è§’ */
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  box-shadow: none; /* ã‚·ãƒ³ãƒ—ãƒ«ã«å½±ãªã— */
  transition: background-color 0.2s;
  background-color: #fff;
}

.auction-card:hover {
  background-color: #f0f0f0;
}

.auction-card img {
  width: 150px;
  height: 150px;
  object-fit: cover;
  flex-shrink: 0;
}

.auction-info {
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.auction-title {
  font-size: 1.2em;
  margin-bottom: 8px;
  font-weight: bold;
  padding-left: 5vw;
}

.auction-detail {
  font-size: 0.9em;
  color: #555;
  padding-left: 6vw;
}

.ended-label {
  display: inline-block;
  background-color: #555;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 0; /* ç›´è§’ */
  margin-top: 8px;
}

.active-label {
  background-color: #222;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 0; /* ç›´è§’ */
  margin-top: 8px;
  display: inline-block;
}

.warning-box {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 0; /* ç›´è§’ */
  padding: 20px;
  max-width: 600px;
  margin: 50px auto;
  text-align: center;
  color: #222;
}

.warning-box button {
  margin-top: 20px;
  padding: 10px 20px;
  font-size: 1em;
  cursor: pointer;
  background-color: #222;
  color: #fff;
  border: none;
  border-radius: 0; /* ç›´è§’ */
}

.warning-box button:hover {
  background-color: #555;
}
  </style>
</head>
<body>

<div id="main-content">
  <h1>é–‹å‚¬ä¸­ã®CoCoã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</h1>
  <div class="auction-list" id="auction-list">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>


<script>
// ä¾¡æ ¼ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•° (ä¾‹: 123456 -> 123,456)
function formatPrice(price) {
    if (typeof price !== 'number' && typeof price !== 'string' || isNaN(Number(price))) {
        console.warn('formatPrice: Invalid number passed', price);
        return price;
    }
    const numericPrice = Number(price);
    return new Intl.NumberFormat('ja-JP').format(numericPrice);
}

const auctionId = getQueryParam("id");

// Firebaseã®è¨­å®š
const firebaseConfig = {
    apiKey: "AIzaSyBImwBMbP_4rbm-dsB2R8dhtlblA9HTBS8",
    authDomain: "coco-auction.firebaseapp.com",
    projectId: "coco-auction",
    storageBucket: "coco-auction.appspot.com",
    messagingSenderId: "12632824391",
    appId: "1:12632824391:web:ab6e784ba311de069eef62"
};
firebase.initializeApp(firebaseConfig);

let auctionEndTime;
let currentUserId = '';
let currentUserName = '';
let lastBidTime = 0;
const BID_COOLDOWN_SECONDS = 30;

const db = firebase.firestore();

const LIFF_ID = "1657196041-ALeOLrEa";
const VERIFY_URL = "https://us-central1-coco-auction.cloudfunctions.net/verifyLineTokenAndSignIn2";

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®è¡¨ç¤º/éè¡¨ç¤º
function showLoading() {
    document.getElementById('loading-screen').style.display = 'flex';
}
function hideLoading() {
    document.getElementById('loading-screen').style.display = 'none';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showModalMessage(text, type = 'info') {
    const msgEl = document.getElementById('modal-message');
    msgEl.textContent = text;
    msgEl.style.color = {
        success: '#27ae60',
        error: '#e74c3c',
        info: '#2980b9'
    }[type] || '#333';
}

// ç”»é¢ä¸‹éƒ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showStatusMessage(text, type = 'info') {
    const msgEl = document.getElementById('message');
    msgEl.textContent = text;
    msgEl.style.color = {
        success: '#27ae60',
        error: '#e74c3c',
        info: '#2980b9'
    }[type] || '#333';
}

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°
function updateCountdown() {
    if (!auctionEndTime) return;

    const now = new Date().getTime();
    const distance = auctionEndTime.getTime() - now;

    const bidButton = document.getElementById('bid-button');
    const yourStatusElement = document.getElementById('your-status');
    const passcodeDisplay = document.getElementById('passcode-display');
    const passcodeValue = document.getElementById('passcode-value');
    const currentPriceDisplayElement = document.getElementById('current-price-display');
    const paymentMethodInfo = document.getElementById('payment-method-info');

    if (distance < 0) {
        document.getElementById('time-remaining').textContent = 'ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã—ãŸ';
        bidButton.disabled = true;

        const currentAuctionData = window.currentAuctionData;
        if (currentAuctionData) {
            if (currentUserId && currentAuctionData.highestBidderId === currentUserId) {
                currentPriceDisplayElement.innerHTML = `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>${formatPrice(currentAuctionData.currentBid || currentAuctionData.startPrice || 100)}å††ã§è½æœ­ã—ã¾ã—ãŸğŸ‰`;
                yourStatusElement.textContent = '';

                if (distance > -2000) { // çµ‚äº†ç›´å¾Œã®ã¿ç´™å¹é›ª
                    launchConfettiTimes(1);
                }

                // privateAuctionInfo ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’éåŒæœŸã§å–å¾—
                db.collection('privateAuctionInfo').doc(auctionId).get().then(privateInfoDoc => {
                    if (privateInfoDoc.exists) {
                        const privateInfoData = privateInfoDoc.data();
                        passcodeValue.textContent = `æš—è¨¼ç•ªå·: ${privateInfoData.passcode || '---'}`;
                    } else {
                        passcodeValue.textContent = `æš—è¨¼ç•ªå·: --- (æƒ…å ±ãªã—)`;
                    }
                    passcodeDisplay.style.display = 'block';
                    paymentMethodInfo.style.display = 'block';
                }).catch(error => {
                    console.error("Failed to get private auction info:", error);
                    passcodeValue.textContent = `æš—è¨¼ç•ªå·: --- (å–å¾—ã‚¨ãƒ©ãƒ¼)`;
                    passcodeDisplay.style.display = 'block';
                    paymentMethodInfo.style.display = 'block';
                });

            } else {
                currentPriceDisplayElement.textContent = `æœ€çµ‚ä¾¡æ ¼ï¼š${formatPrice(currentAuctionData.currentBid || currentAuctionData.startPrice || 100)}å††`;
                yourStatusElement.textContent = `è½æœ­ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`;
                passcodeDisplay.style.display = 'none';
                paymentMethodInfo.style.display = 'none';
            }
        }
        return;
    }
    // ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãŒã¾ã çµ‚äº†ã—ã¦ã„ãªã„å ´åˆã®å‡¦ç†
    else {
        bidButton.disabled = false;
        passcodeDisplay.style.display = 'none';
        paymentMethodInfo.style.display = 'none';
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    document.getElementById('time-remaining').textContent =
        `çµ‚äº†ã¾ã§ï¼š${days}æ—¥${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
}

// UIåæ˜ 
function updateAuctionUI(auctionData, latestBidAmount = 100, highestBidderId = null) {
    document.getElementById('auction-title').textContent = auctionData.title || 'å“ç¨®å';
    document.getElementById('item-overview').textContent = auctionData.description || '----';
    document.getElementById('current-bid').textContent = `${formatPrice(latestBidAmount)}å††`;

    if (currentUserId && highestBidderId === currentUserId) {
        document.getElementById('your-status').textContent = `ç¾åœ¨ã€æœ€é«˜å…¥æœ­è€…ã§ã™ã€‚`;
    } else {
        document.getElementById('your-status').textContent = `è½æœ­ã«ã¯å…¥æœ­ãŒå¿…è¦ã§ã™ã€‚`;
    }

    window.currentAuctionData = auctionData;
    updateCountdown();
}

// URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// LIFFåˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function initializeLiffAndLoadAuction() {
    showLoading();
    document.getElementById('bid-button').disabled = true;

    try {
        console.log('LIFF initialization started.');
        await liff.init({ liffId: LIFF_ID });
        console.log('LIFF initialized.');

        if (!liff.isLoggedIn()) {
            console.log('Not logged in to LIFF. Redirecting for login.');
            liff.login();
            return;
        }

        console.log('Fetching ID token...');
        const idToken = await liff.getIDToken();
        console.log('ID token fetched.');

        console.log('Verifying LINE token and signing into Firebase...');
        const res = await fetch(VERIFY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken })
        });

        if (!res.ok) {
            showStatusMessage(`LINEèªè¨¼ã‚¨ãƒ©ãƒ¼ (status ${res.status})`, 'error');
            const text = await res.text();
            console.error(`LINEèªè¨¼ã‚¨ãƒ©ãƒ¼è©³ç´°: ${text}`);
            hideLoading();
            return;
        }

        const json = await res.json();
        console.log('Firebase token received. Signing in to Firebase...');
        await firebase.auth().signInWithCustomToken(json.firebaseToken);
        console.log('Firebase sign-in complete.');

        currentUserId = firebase.auth().currentUser.uid;
        console.log('Current User ID:', currentUserId);

        if (!auctionId) {
            showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
            console.error('Auction ID is missing.');
            hideLoading();
            return;
        }

        console.log('Setting up Firestore onSnapshot listener for auction data...');
        // Firestoreã‹ã‚‰ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è³¼èª­
        db.collection('auctions').doc(auctionId).onSnapshot(async (doc) => {
            console.log('Firestore snapshot received.');
            if (doc.exists) {
                const auctionData = doc.data();
                auctionEndTime = auctionData.endTime ? auctionData.endTime.toDate() : null;
                console.log('Auction Data:', auctionData);

                let yourBid = 0;
                if (currentUserId) {
                    console.log('Fetching user bids...');
                    const userBidsSnapshot = await db.collection('auctions').doc(auctionId)
                        .collection('bids')
                        .where('userId', '==', currentUserId)
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    if (!userBidsSnapshot.empty) {
                        yourBid = userBidsSnapshot.docs[0].data().amount;
                        lastBidTime = userBidsSnapshot.docs[0].data().timestamp.toDate().getTime();
                        console.log('User bid found:', yourBid);
                    } else {
                        console.log('No user bid found.');
                    }
                }

                const initialDisplayBid = auctionData.currentBid || auctionData.startPrice || 100;
                updateAuctionUI(auctionData, initialDisplayBid, auctionData.highestBidderId);
                console.log('Auction UI updated.');

                // ç”»åƒã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸåŒ–
                console.log('Loading images from Firestore...');
                const imageData = await loadImagesFromFirestore(auctionId);
                console.log('Images loaded. Initializing slider with', imageData.length, 'images.');

                if (imageData.length > 0) {
                    initializeSlider(imageData);
                    console.log('Slider initialized.');
                } else {
                    console.warn('No image data found for slider initialization.');
                }

                if (auctionEndTime && new Date().getTime() < auctionEndTime.getTime()) {
                    document.getElementById('bid-button').disabled = false;
                    console.log('Bid button enabled.');
                } else {
                    document.getElementById('bid-button').disabled = true;
                    console.log('Bid button disabled (auction ended or no end time).');
                }

                showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                console.log('Auction info updated message shown.');

            } else {
                showStatusMessage('æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                document.getElementById('bid-button').disabled = true;
                console.error('Auction document not found.');
            }
            hideLoading();
            console.log('Loading screen hidden.');
        }, (error) => {
            console.error("Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
            showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            hideLoading();
            console.log('Loading screen hidden due to Firestore error.');
        });

        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°ã‚’é–‹å§‹
        setInterval(updateCountdown, 1000);
        console.log('Countdown interval started.');

    } catch (err) {
        console.error('ğŸš« å®Ÿè¡Œä¸­ã‚¨ãƒ©ãƒ¼ (initializeLiffAndLoadAuction):', err);
        showStatusMessage(`åˆæœŸåŒ–ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`, 'error');
        hideLoading();
        console.log('Loading screen hidden due to initialization error.');
    }
}

// DOMContentLoadedã§ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–é–¢æ•°ã‚’å®Ÿè¡Œ
window.addEventListener('DOMContentLoaded', initializeLiffAndLoadAuction);

// å…¥æœ­ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
document.getElementById('bid-button').addEventListener('click', () => {
    if (auctionEndTime && new Date().getTime() >= auctionEndTime.getTime()) {
        showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯æ—¢ã«çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚', 'error');
        return;
    }
    document.getElementById('modal-bid-amount').value = '';
    document.getElementById('modal-agree-checkbox').checked = false;
    showModalMessage('');
    document.getElementById('bid-modal').style.display = 'flex';
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
document.getElementById('modal-cancel-button').addEventListener('click', () => {
    document.getElementById('bid-modal').style.display = 'none';
});

// Firebase Functionsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
const functions = firebase.functions();
// ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã†å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™ (ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚)
// functions.useFunctionsEmulator('http://localhost:5001'); // functionsã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®URL

document.getElementById('modal-submit-button').addEventListener('click', async () => {
    const bidAmountInput = document.getElementById('modal-bid-amount');
    const newBidAmount = Number(bidAmountInput.value); // Number() ã§æ•°å€¤ã«å¤‰æ›

    const agreed = document.getElementById('modal-agree-checkbox').checked;

    // --- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®åŸºæœ¬çš„ãªå…¥åŠ›æ¤œè¨¼ ---
    // (ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚‚åŒæ§˜ã®æ¤œè¨¼ãŒå¿…è¦ã§ã™)
    if (!agreed) {
        showModalMessage('è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }

    if (isNaN(newBidAmount) || newBidAmount < 100 || newBidAmount % 100 !== 0) {
        showModalMessage('100å††å˜ä½ã§æ­£ã—ã„å…¥æœ­é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }

    if (!currentUserId) { // currentUserId ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å–å¾—æ¸ˆã¿ã¨ä»®å®š
        showModalMessage('LINEãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚LIFFã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }

    if (!auctionId) { // auctionId ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å–å¾—æ¸ˆã¿ã¨ä»®å®š
        showModalMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
    }

    // --- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®UXå‘ä¸Šã®ãŸã‚ï¼‰ ---
    const now = new Date().getTime();
    if (lastBidTime && (now - lastBidTime) < (BID_COOLDOWN_SECONDS * 1000)) {
        const remainingTime = Math.ceil((BID_COOLDOWN_SECONDS * 1000 - (now - lastBidTime)) / 1000);
        showModalMessage(`å‰å›ã®å…¥æœ­ã‹ã‚‰${BID_COOLDOWN_SECONDS}ç§’çµŒéã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚ã¨${remainingTime}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`, 'error');
        return;
    }

    // å…¥æœ­ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡¦ç†ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
    document.getElementById('modal-submit-button').disabled = true;
    showModalMessage('å…¥æœ­ä¸­...', 'info');

    try {
        // Cloud Function 'bidAuction' ã‚’å‘¼ã³å‡ºã™
        const bidAuctionFunction = functions.httpsCallable('bidAuction');
        const result = await bidAuctionFunction({ auctionId: auctionId, amount: newBidAmount });

        // Cloud Functionã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
        // Cloud Functionå†…ã§æˆåŠŸ/å¤±æ•—ã®ãƒ•ãƒ©ã‚°ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã‚ˆã†ã«è¨­è¨ˆã™ã‚‹
        if (result.data && result.data.success) {
            showStatusMessage(`å…¥æœ­ãŒæˆåŠŸã—ã¾ã—ãŸï¼`, 'success');
            document.getElementById('bid-modal').style.display = 'none'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            lastBidTime = now; // æˆåŠŸã—ãŸå ´åˆã®ã¿ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ã‚’æ›´æ–°

        } else if (result.data && result.data.message) {
            // Cloud FunctionãŒæˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ãŸãŒã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§å¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹
            showModalMessage(`å…¥æœ­å¤±æ•—: ${result.data.message}`, 'error');
            console.error('Cloud Functionã‹ã‚‰ã®å…¥æœ­å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', result.data.message);
        } else {
            // äºˆæœŸã›ã¬ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
            throw new Error('Cloud Functionã‹ã‚‰ã®äºˆæœŸã›ã¬ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã€‚');
        }
    } catch (error) {
        console.error('å…¥æœ­ã‚¨ãƒ©ãƒ¼:', error);
        // Cloud Functionã‹ã‚‰HttpsErrorãŒè¿”ã•ã‚ŒãŸå ´åˆï¼ˆä¾‹: functions.https.Callableã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ï¼‰
        if (error.code) {
            showModalMessage(`å…¥æœ­ã‚¨ãƒ©ãƒ¼: ${error.message} (${error.code})`, 'error');
        } else {
            // ãã®ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã‚¨ãƒ©ãƒ¼
            showModalMessage(`å…¥æœ­ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
        }
    } finally {
        // å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        document.getElementById('modal-submit-button').disabled = false;
    }
});

// ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function launchConfettiTimes(times) {
    let count = 0;
    function fire() {
        if (count >= times) return;
        confetti({
            particleCount: 90,
            spread: 80,
            origin: { y: 0.6 }
        });
        count++;
        setTimeout(fire, 500);
    }
    fire();
}

// Firestoreã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
async function loadImagesFromFirestore(docId) {
    console.log('loadImagesFromFirestore: Attempting to load images for docId:', docId);
    try {
        const docRef = db.collection("auctions").doc(docId);
        const docSnap = await docRef.get();

        if (!docSnap.exists) {
            console.error("loadImagesFromFirestore: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Document does not exist).");
            return [];
        }

        const auctionData = docSnap.data();
        console.log('loadImagesFromFirestore: Raw auctionData from Firestore:', auctionData);

        // Firestoreã®imagesé…åˆ—ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆç©ºè¦ç´ ã¯é™¤å¤–ï¼‰
        const images = (auctionData.images || []).filter(Boolean);

        console.log('loadImagesFromFirestore: Filtered image URLs:', images);

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¤‰æ›
        const sliderData = images.map(url => ({ imageUrl: url }));
        console.log('loadImagesFromFirestore: Formatted slider data:', sliderData);

        return sliderData;

    } catch (error) {
        console.error("loadImagesFromFirestore: Firestoreå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}

// Slick Carouselã®åˆæœŸåŒ–
function initializeSlider(data) {
    console.log('initializeSlider: Function called with data:', data);
    if (!data || data.length === 0) {
        console.warn('initializeSlider: No data provided or data is empty. Slider will not be initialized.');
        return;
    }

    const slider = $('.slider');
    const thumbnailContainer = $('.thumbnail-container');

    // æ—¢å­˜ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
    if (slider.hasClass('slick-initialized')) {
        console.log('initializeSlider: Slider already initialized, unslicking...');
        slider.slick('unslick');
    }
    slider.empty();
    thumbnailContainer.empty();
    console.log('initializeSlider: Slider and thumbnail containers cleared.');

    let imagesLoadedCount = 0;
    const totalImages = data.length;

    // ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤Promiseã®é…åˆ—ã‚’ä½œæˆ
    const imageLoadPromises = data.map((item, index) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = item.imageUrl;

            // ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å…ˆã«DOMã«è¿½åŠ 
            const thumbnailImg = $(`<img src="${item.imageUrl}" data-index="${index}" alt="ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ ${index + 1}">`);
            thumbnailContainer.append(thumbnailImg);

            img.onload = () => {
                console.log(`initializeSlider: Image loaded: ${item.imageUrl}`);
                const imgDiv = $('<div></div>');
                imgDiv.append($(img).clone());
                slider.append(imgDiv);
                resolve();
            };
            img.onerror = () => {
                console.error(`initializeSlider: Failed to load image: ${item.imageUrl}`);
                resolve(); // ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã§ããªãã¦ã‚‚å‡¦ç†ã‚’ç¶™ç¶š
            };
        });
    });

    // ã™ã¹ã¦ã®ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤
    Promise.all(imageLoadPromises).then(() => {
        console.log('initializeSlider: All images loaded. Initializing Slick Carousel.');
        // ç”»åƒãŒã™ã¹ã¦DOMã«è¿½åŠ ã•ã‚Œã¦ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
        slider.slick({
            slidesToShow: 1,
            slidesToScroll: 1,
            dots: true,
            arrows: true,
            infinite: true,
            adaptiveHeight: true
        });

        // åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ 
        updateThumbnailActive(0);

        // ã‚¹ãƒ©ã‚¤ãƒ‰å¤‰æ›´æ™‚ã«é’æ æ›´æ–°
        slider.on('afterChange', function(event, slick, currentSlide) {
            console.log('initializeSlider: Slick afterChange event. Current slide:', currentSlide);
            updateThumbnailActive(currentSlide);
        });

        // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰ç§»å‹•
        thumbnailContainer.on('click', 'img', function() {
            const index = parseInt($(this).data('index'), 10);
            console.log('initializeSlider: Thumbnail clicked. Going to slide:', index);
            slider.slick('slickGoTo', index);
        });
        console.log('initializeSlider: Event listeners for slider and thumbnails set.');

    }).catch(error => {
        console.error('initializeSlider: An error occurred while waiting for images to load:', error);
    });
}


// é’æ ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateThumbnailActive(index) {
    $('.thumbnail-container img').removeClass('active');
    $(`.thumbnail-container img[data-index="${index}"]`).addClass('active');
    console.log('updateThumbnailActive: Active thumbnail set to index:', index);
}
</script>

</body>
</html>
