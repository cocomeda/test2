<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCoãƒ¡ãƒ€ã‚«ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> 
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
 
<style>

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f7f6;
    margin: 0;
    padding: 20px;
    color: #333;

}

.container {
    max-width: 600px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 30px;
}

h1, h2 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 4vw;
}

hr {
    border: none;
    border-top: 1px dashed #e0e0e0;
    margin: 1vw 0;
}

.product-section {
    text-align: center;
}

.product-media img {
    max-width: 100%; /* è¦ªè¦ç´ ã®å¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
    height: auto; /* ç”»åƒã®æ¯”ç‡ã‚’ç¶­æŒã™ã‚‹ */
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: 80vw; /* ã“ã“ã§ç”»åƒã®æ¨ªå¹…ã‚’300pxã«æŒ‡å®š */
}

.product-description {
    font-size: 0.95em;
    color: #555;
    text-align: left;
}

.auction-info0 {
    text-align: center;
    font-size: 8vw;
    font-weight: bold;
    color:black;
}

.auction-info {
    text-align: center;
    font-size: 5vw;
    font-weight: bold;
    color:black;
}


.auction-info2 {
    text-align: center;
    font-size: 4vw;
    font-weight: bold;
    color:#27ae60; /* ç·‘è‰²ã§ç›®ç«‹ãŸã›ã‚‹ */
}    

.bid-section {
    padding: 15px 20px 20px 20px; /* ä¸Šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
    margin-top: 10px;             /* å¿…è¦ãªã‚‰ã“ã“ã‚‚æ¸›ã‚‰ã™ */
    background-color:lightblue;    /* #f9f9f9;*/
    border-radius: 8px;
    border: 1px solid #eee;
}

.bid-section h2 {
    margin-top: 0;
    margin-bottom: 1px;
    font-size: 1.2em;
}


    
.bid-section_current {
    padding: 15px 20px 20px 20px; /* ä¸Šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
    margin-top: 10px;             /* å¿…è¦ãªã‚‰ã“ã“ã‚‚æ¸›ã‚‰ã™ */
    background-color:;    /* #f9f9f9;*/
    border-radius: 0.2vw;
    border: 1px solid black;
    box-shadow: 3px 2px 2px gray;
}

.bid-section_current h2 {
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
}

    

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #555;
}

.input-group input[type="number"] {
    width: calc(100% - 20px); /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ã‚’è€ƒæ…®ã—ã¦å¹…ã‚’èª¿æ•´ */
    padding: 12px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
}

.input-group input[type="checkbox"] {
    margin-right: 8px;
}

button {
    display: block;
    width: 100%;
    padding: 1vw;
    background-color: #007bff; /* é’è‰²ãƒœã‚¿ãƒ³ */
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #0056b3;
}

button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.message {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    color: #d35400; /* ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Šã¯ã‚ªãƒ¬ãƒ³ã‚¸ */
}

.status-message {
    font-size: 1em;
    font-weight: normal;
    color: #27ae60; /* è‡ªåˆ†ã®çŠ¶æ…‹ã¯ç·‘è‰² */
    margin-top: 5px;
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
@media (max-width: 600px) {
    body {
        padding: 10px;
    }
    .container {
        padding: 20px;
        margin: 10px auto;
    }
    .product-media img {
        width: 100%; /* å°ã•ã„ç”»é¢ã§ã¯æ¨ªå¹…ã„ã£ã±ã„ã«è¡¨ç¤º */
    }
}

.input-group.horizontal {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã¨ä½ç½®èª¿æ•´ */
.input-group.horizontal input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #007bff;
    margin: 0;
    display: inline-block;
}

/* ãƒ©ãƒ™ãƒ«ã®ä½ç½®èª¿æ•´ï¼ˆé«˜ã•ã‚’åˆã‚ã›ã‚‹ï¼‰ */
.input-group.horizontal label {
    margin: 0;
    line-height: 1;
    display: inline-block;
}

/* é‡‘é¡å…¥åŠ›æ¬„ã®å³å¯„ã›ã¨å††è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.currency-input .input-wrapper {
    position: relative;
    width: 100%;
}

.currency-input input[type="number"] {
    width: 100%;
    padding: 12px 35px 12px 10px; /* å³ã«ä½™ç™½ã‚’è¿½åŠ ã—ã¦å††ãƒ©ãƒ™ãƒ«åˆ†ã‚’ç¢ºä¿ */
    text-align: right; /* å³å¯„ã› */
    font-size: 1em;
    box-sizing: border-box;
}

.currency-input .yen-label {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #555;
    font-size: 1em;
}

/* è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
.time-info {
    text-align: center;
    font-size: 1em;
    color: #555;
    margin-top: 10px;
}
.countdown {
    font-size: 1.2em;
    font-weight: bold;
    color: #e74c3c; /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¯èµ¤è‰²ã§ç›®ç«‹ãŸã›ã‚‹ */
    margin-top: 5px;
    text-align: center;
}





#bid-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

#modal-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
}

#modal-content {
    position: relative;
    background: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    width: 90vw;
    max-width: 400px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ãã‚‹ãã‚‹ */
.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #007bff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.title-box {
  background-color: #f9f9f9;
  border: 2px solid #ccc;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 1.5em;
  text-align: center;
  margin: 20px 0;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
}


</style>
</head>
<body>

<div id="loading-screen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
">
  <div class="loader"></div>
</div>




    <div class="container">
        <div class="product-section">
       <h2>CoCoã‚ã ã‹ç„¡äººã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</h2>
<h2 id="auction-title" class="title-box">å“ç¨®å</h2>
            <div class="product-media">
                <img id="medaka-image" src="" alt="ãƒ¡ãƒ€ã‚«ã®ç”»åƒ">
                </div>
            <p id="item-overview" class="product-description">
                ----
            </p>
        </div>

        <hr>
      <div class="bid-section_current">
        <div class="auction-info">
            <p id="current-price-display">ç¾åœ¨ã®ä¾¡æ ¼: <span id="current-bid">--å††</span></p>
     </div>


          
<div class="auction-info2">
            <p id="your-status" class="status-message"></p>
        
            </div>
      </div>

   
<p class="countdown"><span id="time-remaining">--æ—¥--æ™‚é–“--åˆ†--ç§’</span></p>




          
          <div id="passcode-display" style="display: none; margin-top: 20px;">
    <p class="auction-info0" id="passcode-value"></p>
          </div>



    <p class="payment-info" id="payment-method-info" style="font-size: 0.8em; color: #666; margin-top: 5px;">
    â€»ä»£é‡‘ã¯ä»£é‡‘ç®±ã«å…¥ã‚Œã‚‹ã‹ã€PayPayã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚
    </p>
    </div>

        
        
        <hr>

<div id="bid-modal" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;">
  <div style="
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 80vw;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
    
    <h2 style="margin-top: 0;">å…¥æœ­å†…å®¹ã‚’å…¥åŠ›</h2>
    
    <div class="input-group currency-input">
      <label for="modal-bid-amount">å…¥æœ­é‡‘é¡ (100å††å˜ä½):</label>
      <div class="input-wrapper" style="position: relative;">
        <input type="number" id="modal-bid-amount" min="100" step="100" placeholder="ä¾‹: 1500" required>
        <span class="yen-label" style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          color: #555;">å††</span>
      </div>
    </div>

    <div class="input-group horizontal" style="margin-top: 15px;">
      <input type="checkbox" id="modal-agree-checkbox" required>
      <label for="modal-agree-checkbox">ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³è¦ç´„ã«åŒæ„ã™ã‚‹</label>
    </div>

    <p id="modal-message" class="message" style="margin-top: 10px;"></p>

    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
      <button id="modal-cancel-button" style="width: 45%; background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="modal-submit-button" style="width: 45%;">å…¥æœ­ã™ã‚‹</button>
    </div>

  </div>
</div>

<div style="text-align:center; margin-top:20px;">
  <button id="bid-button">å…¥æœ­ã™ã‚‹</button>
  <p id="message" class="message"></p>
</div>





<script>
    // --- ã‚ãªãŸã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyBImwBMbP_4rbm-dsB2R8dhtlblA9HTBS8",
  authDomain: "coco-auction.firebaseapp.com",
  projectId: "coco-auction",
  storageBucket: "coco-auction.firebasestorage.app",
  messagingSenderId: "12632824391",
  appId: "1:12632824391:web:ab6e784ba311de069eef62",
  measurementId: "G-ZGX9JVVKE6"
};

// Firebaseã®åˆæœŸåŒ–
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const functions = firebase.functions(); // â˜…è¿½åŠ : Functionsã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
const placeBidFunction = functions.httpsCallable('placeBid'); // â˜…è¿½åŠ : placeBid Cloud Functionã®å‘¼ã³å‡ºã—å¯èƒ½ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ


// LIFF ID
// TODO: ã“ã“ã‚’ã‚ãªãŸã®LIFF IDã«ç½®ãæ›ãˆã¦ãã ã•ã„
const LIFF_ID = '1657196041-ALeOLrEa'; 







 // LIFFåˆæœŸåŒ– & Firebaseèªè¨¼
  window.addEventListener('load', async () => {
    await liff.init({ liffId: LIFF_ID }); // LIFF_IDå®šæ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const idToken = await liff.getIDToken();
    const res = await fetch('https://us-central1-coco-auction.cloudfunctions.net/verifyLineTokenAndSignIn2', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken })
    });

    const { firebaseToken } = await res.json();
    await firebase.auth().signInWithCustomToken(firebaseToken);

    console.log("âœ… Firebase ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ:", firebase.auth().currentUser.uid);
  });










let auctionEndTime;

// â˜…â˜…â˜… LIFFå¯¾å¿œå¤‰æ›´ç‚¹ â˜…â˜…â˜…
// LIFFã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã€åˆæœŸå€¤ã¯ç©ºã«ã™ã‚‹
let currentUserId = ''; 
let currentUserName = '';
// â˜…â˜…â˜… LIFFå¯¾å¿œå¤‰æ›´ç‚¹ã“ã“ã¾ã§ â˜…â˜…â˜…

let lastBidTime = 0;
const BID_COOLDOWN_SECONDS = 10; // â˜…Functionsã¨åˆã‚ã›ã‚‹ãŸã‚30ç§’ã‹ã‚‰10ç§’ã«ä¿®æ­£

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡
function showLoading() {
  document.getElementById('loading-screen').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loading-screen').style.display = 'none';
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼‰
function showModalMessage(text, type = 'info') {
  const msgEl = document.getElementById('modal-message');
  msgEl.textContent = text;
  msgEl.style.color = {
    success: '#27ae60',
    error: '#e74c3c',
    info: '#2980b9'
  }[type] || '#333';
}

// çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç”»é¢ä¸‹ï¼‰
function showStatusMessage(text, type = 'info') {
  const msgEl = document.getElementById('message');
  msgEl.textContent = text;
  msgEl.style.color = {
    success: '#27ae60',
    error: '#e74c3c',
    info: '#2980b9'
  }[type] || '#333';
}

// ç¾åœ¨ã®å…¥æœ­ãƒ»æ™‚é–“è¡¨ç¤º
function updateCurrentTime() {
  const now = new Date();
  // document.getElementById('current-time').textContent = now.toLocaleTimeString(); // ã“ã®è¦ç´ ã¯HTMLã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ä¸è¦
}

function updateCountdown() {
  if (!auctionEndTime) return;

  const now = new Date().getTime();
  const distance = auctionEndTime.getTime() - now;

  const bidButton = document.getElementById('bid-button');
  const currentBidElement = document.getElementById('current-bid');
  const yourStatusElement = document.getElementById('your-status');
  const passcodeDisplay = document.getElementById('passcode-display');
  const passcodeValue = document.getElementById('passcode-value');
  // const passcodeDisplay2 = document.getElementById('passcode-display2'); // ã“ã®è¦ç´ ã¯HTMLã«å­˜åœ¨ã—ãªã„ãŸã‚å‰Šé™¤

  const currentPriceDisplayElement = document.getElementById('current-price-display');
  const paymentMethodInfo = document.getElementById('payment-method-info'); // æ–°ã—ã„è¦ç´ ã‚’å–å¾—

    
  if (distance < 0) {
    document.getElementById('time-remaining').textContent = 'ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã—ãŸ';
    bidButton.disabled = true;

    const currentAuctionData = window.currentAuctionData;
    if (currentAuctionData) {
        if (currentUserId && currentAuctionData.highestBidderId === currentUserId) {
            currentPriceDisplayElement.innerHTML = `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>${currentAuctionData.currentBid || currentAuctionData.startPrice}å††ã§è½æœ­ã—ã¾ã—ãŸğŸ‰`;
            yourStatusElement.textContent = '';
            passcodeValue.textContent = `æš—è¨¼ç•ªå·: ${currentAuctionData.passcode || '---'}`;
            passcodeDisplay.style.display = 'block';
            paymentMethodInfo.style.display = 'block'; // â˜… æ”¯æ‰•ã„æ–¹æ³•ã‚‚è¡¨ç¤º

            
        } else {
            currentPriceDisplayElement.textContent = `æœ€çµ‚ä¾¡æ ¼ï¼š${currentAuctionData.currentBid || currentAuctionData.startPrice}å††`;
            yourStatusElement.textContent = `è½æœ­ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`;
            passcodeDisplay.style.display = 'none';
            paymentMethodInfo.style.display = 'none'; // â˜… æ”¯æ‰•ã„æ–¹æ³•ã‚‚éè¡¨ç¤º
        }
    }
    return; // çµ‚äº†å¾Œã®å‡¦ç†ãªã®ã§ã€ã“ã‚Œä»¥é™ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨ˆç®—ã¯ä¸è¦
  }
  // ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãŒã¾ã çµ‚äº†ã—ã¦ã„ãªã„å ´åˆã®å‡¦ç†
  else {
    bidButton.disabled = false; // å…¥æœ­ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    passcodeDisplay.style.display = 'none'; // æš—è¨¼ç•ªå·è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éš ã™
    paymentMethodInfo.style.display = 'none'; // æ”¯æ‰•ã„æ–¹æ³•è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éš ã™
  }

  const days = Math.floor(distance / (1000 * 60 * 60 * 24));
  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);

  document.getElementById('time-remaining').textContent =
    `çµ‚äº†ã¾ã§ï¼š${days}æ—¥${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
}

// UIåæ˜ 
function updateAuctionUI(auctionData, latestBidAmount = 0, highestBidderId = null, yourBidAmount = 0) {
  document.getElementById('auction-title').textContent = auctionData.title || 'å“ç¨®å';
  document.getElementById("medaka-image").src = auctionData.imageUrl || auctionData.image || '';
  document.getElementById('item-overview').textContent = auctionData.description || '----';
  document.getElementById('current-bid').textContent = `${latestBidAmount}å††`;

  if (currentUserId && highestBidderId === currentUserId) {
    document.getElementById('your-status').textContent = `ã‚ãªãŸãŒæœ€é«˜é¡ï¼`;
  } else {
    document.getElementById('your-status').textContent = `ã‚ãªãŸã®å…¥æœ­é¡: ${yourBidAmount > 0 ? yourBidAmount + 'å††' : '---'}`;
  }

  window.currentAuctionData = auctionData;

  updateCountdown();
}

// URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getQueryParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³IDã‚’å–å¾—
const auctionId = getQueryParam("id"); 

// LIFFåˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function initializeLiffAndLoadAuction() {
  showLoading();
  document.getElementById('bid-button').disabled = true;

  try {
    // â˜…â˜…â˜… LIFFå¯¾å¿œå¤‰æ›´ç‚¹ â˜…â˜…â˜…
    await liff.init({ liffId: LIFF_ID });

    console.log("LIFF initialized successfully");
    console.log("is logged in:", liff.isLoggedIn());

      
    if (!liff.isLoggedIn()) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLINEã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      liff.login();
      return; 
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨è¡¨ç¤ºåã®å–å¾—
    const profile = await liff.getProfile();
    currentUserId = liff.getDecodedIDToken().sub; // IDãƒˆãƒ¼ã‚¯ãƒ³ã®subã‚¯ãƒ¬ãƒ¼ãƒ ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    currentUserName = profile.displayName; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰è¡¨ç¤ºåã‚’å–å¾—
    
    // â˜…â˜…â˜… LIFFå¯¾å¿œå¤‰æ›´ç‚¹ã“ã“ã¾ã§ â˜…â˜…â˜…

    if (!auctionId) {
      showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
      hideLoading();
      return;
    }

    // Firestoreã‹ã‚‰ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è³¼èª­
    db.collection('auctions').doc(auctionId).onSnapshot(async (doc) => {
      if (doc.exists) {
        const auctionData = doc.data();
        auctionEndTime = auctionData.endTime ? auctionData.endTime.toDate() : null;

        let yourBid = 0;
        // currentUserIdãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆLIFFãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆï¼‰
        if (currentUserId) { 
            const userBidsSnapshot = await db.collection('auctions').doc(auctionId)
                                            .collection('bids')
                                            .where('userId', '==', currentUserId)
                                            .orderBy('timestamp', 'desc')
                                            .limit(1)
                                            .get();
            if (!userBidsSnapshot.empty) {
                yourBid = userBidsSnapshot.docs[0].data().amount;
                // lastBidTime ã¯ UI ã®ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ãªã®ã§ã€æœ€æ–°ã®å…¥æœ­æ™‚é–“ã§æ›´æ–°
                lastBidTime = userBidsSnapshot.docs[0].data().timestamp.toDate().getTime();
            }
        }
        
        updateAuctionUI(auctionData, auctionData.currentBid || auctionData.startPrice, auctionData.highestBidderId, yourBid);
        
        if (auctionEndTime && new Date().getTime() < auctionEndTime.getTime()) {
            document.getElementById('bid-button').disabled = false;
        } else {
            document.getElementById('bid-button').disabled = true;
        }

        showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');

      } else {
        showStatusMessage('æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
        document.getElementById('bid-button').disabled = true;
      }
      hideLoading();
    }, (error) => {
      console.error("Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
      showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      hideLoading();
    });

    // æ™‚åˆ»ã¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°ã‚’é–‹å§‹
    // updateCurrentTime(); // HTMLã§è¡¨ç¤ºã—ã¦ã„ãªã„ãŸã‚å‰Šé™¤
    // setInterval(updateCurrentTime, 1000); // HTMLã§è¡¨ç¤ºã—ã¦ã„ãªã„ãŸã‚å‰Šé™¤
    setInterval(updateCountdown, 1000);

  } catch (error) {
    console.error('LIFFåˆæœŸåŒ–ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    showStatusMessage('LIFFã®åˆæœŸåŒ–ã¾ãŸã¯LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
    hideLoading();
  }
}


  
// DOMåˆæœŸåŒ–
window.addEventListener('DOMContentLoaded', initializeLiffAndLoadAuction);

// å…¥æœ­ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
document.getElementById('bid-button').addEventListener('click', () => {
    // ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹å†åº¦ãƒã‚§ãƒƒã‚¯
    if (auctionEndTime && new Date().getTime() >= auctionEndTime.getTime()) {
        showStatusMessage('ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯æ—¢ã«çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚', 'error');
        return;
    }
    document.getElementById('modal-bid-amount').value = '';
    document.getElementById('modal-agree-checkbox').checked = false;
    showModalMessage('');
    document.getElementById('bid-modal').style.display = 'flex';
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
document.getElementById('modal-cancel-button').addEventListener('click', () => {
    document.getElementById('bid-modal').style.display = 'none';
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…é€ä¿¡å‡¦ç†
document.getElementById('modal-submit-button').addEventListener('click', async () => {
    const bidAmount = Number(document.getElementById('modal-bid-amount').value);
    const agreed = document.getElementById('modal-agree-checkbox').checked;

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®åŸºæœ¬çš„ãªå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!agreed) {
      showModalMessage('è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    if (isNaN(bidAmount) || bidAmount < 100 || bidAmount % 100 !== 0) {
      showModalMessage('100å††å˜ä½ã®æ­£ã—ã„å…¥æœ­é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    if (!currentUserId) {
        showModalMessage('LINEãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚LIFFã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }

    // ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾— (UIæ›´æ–°ã®ãŸã‚ã«å¿…è¦ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®FunctionsãŒæœ€çµ‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†)
    const auctionDocSnap = await db.collection('auctions').doc(auctionId).get();
    if (!auctionDocSnap.exists) {
        showModalMessage('æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
    }
    const currentAuctionData = auctionDocSnap.data();
    const currentMaxBid = currentAuctionData.currentBid || currentAuctionData.startPrice;
    const auctionEndDate = currentAuctionData.endTime ? currentAuctionData.endTime.toDate() : null;

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆUXã®ãŸã‚ã€‚FunctionsãŒæœ€çµ‚æ±ºå®šï¼‰
    if (auctionEndDate && new Date() > auctionEndDate) {
        showModalMessage("ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¯æ—¢ã«çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚", 'error');
        return;
    }
    if (bidAmount <= currentMaxBid) {
        showModalMessage(`ç¾åœ¨ã®æœ€é«˜é¡ (${currentMaxBid}å††) ã‚ˆã‚Šé«˜ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`, 'error');
        return;
    }
    const MAX_BID_MULTIPLIER = 5;
    const maxAllowedBid = currentMaxBid * MAX_BID_MULTIPLIER;
    if (bidAmount > maxAllowedBid) {
        showModalMessage(`å…¥æœ­é¡ã¯ç¾åœ¨ã®æœ€é«˜é¡ã®${MAX_BID_MULTIPLIER}å€ (${maxAllowedBid}å††) ã‚’è¶…ãˆã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`, 'error');
        return;
    }

    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒã‚§ãƒƒã‚¯
    // lastBidTime ã¯ initializeLiffAndLoadAuction ã§æœ€æ–°å…¥æœ­æ—¥æ™‚ãŒå–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
    if (lastBidTime && (new Date().getTime() - lastBidTime) < (BID_COOLDOWN_SECONDS * 1000)) {
        const remainingTime = Math.ceil((BID_COOLDOWN_SECONDS * 1000 - (new Date().getTime() - lastBidTime)) / 1000);
        showModalMessage(`å‰å›ã®å…¥æœ­ã‹ã‚‰${BID_COOLDOWN_SECONDS}ç§’çµŒéã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚ã¨${remainingTime}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`, 'error');
        return;
    }


    document.getElementById('modal-submit-button').disabled = true;
    showModalMessage('å…¥æœ­ä¸­...', 'info');

    try {
        // â˜…é‡è¦: Cloud Functionã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«å¤‰æ›´â˜…
        const result = await placeBidFunction({
            auctionId: auctionId,
            bidAmount: bidAmount
        });

        if (result.data.status === 'success') {
            showStatusMessage(result.data.message, 'success');
            document.getElementById('bid-modal').style.display = 'none';
            // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã®UIè¡¨ç¤ºã®ãŸã‚ã«ã€æˆåŠŸã—ãŸã‚‰ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨˜éŒ²
            lastBidTime = new Date().getTime(); 
        } else {
            // Cloud Functionã‹ã‚‰è¿”ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            let errorMessage = result.data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            // Cloud Functionsã‹ã‚‰ã®HttpsErrorã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            if (result.data.code === 'unauthenticated') {
                errorMessage = 'èªè¨¼ãŒå¿…è¦ã§ã™ã€‚LINEã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚';
            } else if (result.data.code === 'failed-precondition' || result.data.code === 'invalid-argument' || result.data.code === 'not-found') {
                // ã“ã‚Œã‚‰ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯placeBidé–¢æ•°ã‹ã‚‰ã®å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã¤ã¯ãš
                errorMessage = result.data.message;
            }
            showModalMessage(`å…¥æœ­å¤±æ•—: ${errorMessage}`, 'error');
        }

    } catch (error) {
        console.error("å…¥æœ­ã‚¨ãƒ©ãƒ¼:", error.code, error.message);
        let errorMessage = 'å…¥æœ­å‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        // Firebase Functionsã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
        if (error.code) { 
            errorMessage = error.message; // HttpsErrorã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›´æ¥è¡¨ç¤º
        }
        showModalMessage(`å…¥æœ­ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}`, 'error');
    } finally {
        document.getElementById('modal-submit-button').disabled = false;
    }
});

</script>

</body>
</html>
