<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF IDãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>LIFF â†’ verifyLineTokenAndSignIn2 ãƒ†ã‚¹ãƒˆ</h2>
  <button id="run-test">èªè¨¼ï¼†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
  <pre id="result" style="white-space:pre-wrap;"></pre>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBImwBMbP_4rbm-dsB2R8dhtlblA9HTBS8",
      authDomain: "coco-auction.firebaseapp.com",
      projectId: "coco-auction",
      storageBucket: "coco-auction.appspot.com",
      messagingSenderId: "12632824391",
      appId: "1:12632824391:web:ab6e784ba311de069eef62"
    };
    firebase.initializeApp(firebaseConfig);

    const LIFF_ID = "1657196041-ALeOLrEa";
    const VERIFY_URL = "https://us-central1-coco-auction.cloudfunctions.net/verifyLineTokenAndSignIn2";

    document.getElementById('run-test').addEventListener('click', async () => {
      const output = document.getElementById('result');
      output.textContent = "åˆæœŸåŒ–ä¸­...";

      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          output.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™...";
          liff.login();
          return;
        }

        const idToken = await liff.getIDToken();
        alert(idToken);

        output.textContent = "IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸã€‚\né€ä¿¡ä¸­...";

        const res = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });

        if (!res.ok) {
          const text = await res.text();
          output.textContent = `âŒ ã‚¨ãƒ©ãƒ¼ (status ${res.status}):\n${text}`;
          return;
        }

        const json = await res.json();
        output.textContent = `âœ… æˆåŠŸ:\nFirebase Token:\n${json.firebaseToken}`;

        await firebase.auth().signInWithCustomToken(json.firebaseToken);
        output.textContent += "\nFirebaseãƒ­ã‚°ã‚¤ãƒ³å®Œäº† âœ…";

        const db = firebase.firestore();
        const uid = firebase.auth().currentUser.uid;
        const doc = await db.collection("users").doc(uid).get();

        if (doc.exists) {
          output.textContent += `\nãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:\n${JSON.stringify(doc.data(), null, 2)}`;
        } else {
          output.textContent += "\nãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        }

      } catch (err) {
        output.textContent = `ğŸš« å®Ÿè¡Œä¸­ã‚¨ãƒ©ãƒ¼:\n${err}`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
